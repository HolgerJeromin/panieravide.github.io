<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>Yo Hours</title>
	<script src="//code.jquery.com/jquery-1.10.2.js"></script>
	<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
	<link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
</head>
<body>
	<h1>Yo Hours</h1>
	
	<div id="about">
		<p>Define the <a href="https://wiki.openstreetmap.org/wiki/Key:opening_hours">opening hours</a> for OpenStreetMap simply !<br />
		Just add time intervals, and we will do the job.</p>
	</div>
	
	<div id="defined_intervals">
		<h2>Defined hours</h2>
		<p>OSM opening_hours = <input type="text" id="oh" readonly /></p>
		<ul id="intervals_list">
		</ul>
	</div>
	
	<div id="interval">
		<h2>New interval</h2>
		<p>
			<select id="day">
				<option value="0">Monday</option>
				<option value="1">Tuesday</option>
				<option value="2">Wednesday</option>
				<option value="3">Thursday</option>
				<option value="4">Friday</option>
				<option value="5">Saturday</option>
				<option value="6">Sunday</option>
			</select>
			<span id="hours_start"></span> - <span id="hours_end"></span>
		</p>
		<div id="slider-range"></div>
		<p><input type="button" id="new_interval" value="Add" /></p>
	</div>
	
	<script type="text/javascript">
		//Variables
		var intervals = new Object();
		
		/**
		 * Converts minutes into HH:MM format
		 * @param m The amount of minutes
		 */
		function minToHourMin(m) {
			var hours = Math.floor(m/60);
			if(hours < 10) { hours = "0"+hours; }
			var minutes = m % 60;
			if(minutes < 10) { minutes = "0"+minutes; }
			return hours+":"+minutes;
		};
		
		function osmdayToDay(d) {
			var days = [ "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday" ];
			return days[d];
		};
		
		/**
		 * Updates the hours field in page
		 * @param minStart The start hour (in minutes since midnight)
		 * @param minEnd The end hour (in minutes since midnight)
		 */
		function updateHours(minStart, minEnd) {
			$( "#hours_start" ).html(minToHourMin(minStart));
			$( "#hours_end" ).html(minToHourMin(minEnd));
		};
		
		function resetSlider() {
			$( "#slider-range" ).slider({
				range: true,
				min: 0,
				max: 24*60,
				step: 5,
				values: [ 8*60, 12*60 ],
				slide: function( event, ui ) {
					updateHours(ui.values[0], ui.values[1]);
				}
			});
			updateHours($("#slider-range").slider("values", 0), $("#slider-range").slider("values", 1));
		};
		
		/**
		 * Resets the new interval section
		 */
		function resetNewInterval() {
			/*resetSlider();
			$("#day").val("0");*/
		};
		
		function addCurrentInterval() {
			var id = countIntervals();
			
			//Add new interval in list
			$("#intervals_list").append(
				"<li id=\"val_"+id+"\">"+osmdayToDay($("#day").val())
				+" "+$("#hours_start").html()
				+" - "+$("#hours_end").html()
				+" <small><a href=\"#\" id=\"rm_"+id+"\">Remove</a></small></li>");
			
			$("#rm_"+id).click(function() {
				intervals[id] = undefined;
				$("#val_"+id).remove();
				updateOh();
			});
			
			//Add new interval in data
			intervals[id] = { day: $("#day").val(), from: $("#slider-range").slider("values", 0), to: $("#slider-range").slider("values", 1) };
			updateOh();
			
			//Reset UI
			resetNewInterval();
		};
		
		function countIntervals() {
			return $("#intervals_list li").length;
		};
		
		function updateOh() {
			$("#oh").val(makeStringFromIntervals(intervals));
		};
		
		/**
		 * Returns a String (e.g "Mo-Sa 10:00-20:00; Tu off") representing the intervals
		 * @param intervals The time intervals
		 * @return The formated string
		 */
		function makeStringFromIntervals(intervals) {
			// create an array of booleans representing every minute on all the days in a week
			var minuteArray = new Array(7);
			for(var day = 0; day < 7; day++) {
				minuteArray[day] = new Array(24*60 + 2);
				for (var minute = 0; minute < 24 * 60 + 2; minute++) {
					minuteArray[day][minute] = false;
				}
			}
			
			for(var id in intervals) {
				if(intervals.hasOwnProperty(id) && intervals[id] != undefined) {
					for (var minute = intervals[id].from; minute <= intervals[id].to; minute++) {
						minuteArray[intervals[id].day][minute] = true;
					}
				}
			}
			
			var ret = "";
			var days = new Array(7); // an array representing the status of the days
			for(var i=0; i < days.length; i++) {
				days[i] = 0;
			}
			// 0 means nothing done with this day yet
			// 8 means the day is off
			// 0<x<8 means the day have the openinghours of day x
			// -8<x<0 means nothing done with this day yet, but it intersects a
			// range of days with same opening_hours
			for(var i = 0; i < 7; i++) {
				var add = "";
				
				if (isArrayEmpty(minuteArray[i]) && days[i] == 0) {
					days[i] = 8;
				} else if (isArrayEmpty(minuteArray[i]) && days[i] < 0) {
					add = dayToOsmday(i) + " off";
					days[i] = -8;
				} else if (days[i] <= 0) {
					days[i] = i + 1;
					var lastSameDay = i;
					var sameDayCount = 1;
					
					for(var j = i + 1; j < 7; j++) {
						if (arraysEqual(minuteArray[i], minuteArray[j])) {
							days[j] = i + 1;
							lastSameDay = j;
							sameDayCount++;
						}
					}
					if (sameDayCount == 1) {
						// a single Day with this special opening_hours
						add = dayToOsmday(i) + " " + makeStringFromMinuteArray(minuteArray[i]);
					} else if (sameDayCount == 2) {
						// exactly two Days with this special opening_hours
						add = dayToOsmday(i) + "," + dayToOsmday(lastSameDay) + " "
						+ makeStringFromMinuteArray(minuteArray[i]);
					} else if (sameDayCount > 2) {
						// more than two Days with this special opening_hours
						add = dayToOsmday(i) + "-" + dayToOsmday(lastSameDay) + " "
						+ makeStringFromMinuteArray(minuteArray[i]);
						for (var j = i + 1; j < lastSameDay; j++) {
							if (days[j] == 0) {
								days[j] = -i - 1;
							}
						}
					}
				}
				
				if (add.length > 0) {
					if (ret.length > 0) {
						ret += "; ";
					}
					ret += add;
				}
			}
			return ret;
		};

		function isArrayEmpty(bs) {
			for(var i = 0; i < bs.length; i++) {
				if (bs[i]) {
					return false;
				}
			}
			return true;
		};

		function arraysEqual(bs, bs2) {
			var ret = true;
			for(var i = 0; i < bs.length; i++) {
				ret &= bs[i] == bs2[i];
			}
			return ret;
		};

		function dayToOsmday(d) {
			var days = [ "Mo", "Tu", "We", "Th", "Fr", "Sa", "Su" ];
			return days[d];
		};

		/**
		 * Returns a String representing the openinghours on one special day (e.g. "10:00-20:00")
		 */
		function makeStringFromMinuteArray(minutes) {
			var ret = "";
			for (var i = 0; i < minutes.length; i++) {
				if (minutes[i]) {
					var start = i;
					while (i < minutes.length && minutes[i]) {
						i++;
					}
					var addString = timeString(start);
					if (i - 1 == 24 * 60 + 1) {
						addString += "+";
					} else if (start != i - 1) {
						addString += "-" + timeString(i - 1);
					}
					if (ret.length > 0) {
						ret += ",";
					}
					ret += addString;
				}
			}
			return ret;
		};

		/**
		* @param minutes integer in range from 0 and 24*60 inclusive
		* @return a formatted string of the time (for example "01:45 PM" or "13:45")
		*/
		function timeString(minutes) {
			var h = Math.floor(minutes / 60);
			var period = "";
			var m = minutes % 60;
			return (h < 10 ? "0" : "") + h + ":" + (m < 10 ? "0" : "") + m + period;
		};


		
		/**
		 * Event handler for slide range widget
		 */
		$(resetSlider());
		
		//Event handler for add interval button
		$("#new_interval").click(addCurrentInterval);
		$("#oh").val("");
	</script>
</body>
</html>